              	; --------------------------------------
              	; zasm: assemble "init.asm"
              	; date: 2023-05-21 23:17:15
              	; --------------------------------------


              	;
              	;**************************************************************
              	;*
              	;*                I S H K U R   I N I T
              	;*
              	;*      This program should run when IshkurCP/M first 
              	;*      starts up. It will display a hello banner and
              	;*      load in user settings
              	;*
              	;*      It can also be used to configure on-boot settings
              	;*      by running INIT after the system has booted
              	;*
              	;*	This version of INIT is for the NABU computer with
              	;*      TMS9918 console.
              	;*
              	;**************************************************************
              	;
              	
              	; Equates
0005:         	bdos	equ	0x0005
005C:         	fcb	equ	0x005C
0080:         	cmdlen	equ	0x0080
0081:         	cmdarg	equ	0x0081
              	
00A0:         	tm_data	equ	0xA0	; TMS9918 data register (mode=0)
00A1:         	tm_latc	equ	0xA1	; TMS9918 latch register (mode=1)
              	
              	
              	; Program start
0100:         		org	0x0100
              		
              		; Check to see if we are running for the first time
0100: 3A8000  		ld	a,(cmdlen)
0103: FE02    		cp	2
0105: C23F01  		jp	nz,config
0108: 3A8200  		ld	a,(cmdarg+1)
010B: FEFF    		cp	255
010D: C23F01  		jp	nz,config
              		
              		; Attempt to find INIT.INI
0110: CD3702  		call	openini
0113: CA2401  		jp	z,banner	; Can't open, just exit
              		
0116: CD2D01  		call	docfg
              		
              		; Check which banner to show
0119: 3AF905  		ld	a,(f18a80)
011C: B7      		or	a
011D: 2805    		jr	z,banner
011F: 110103  		ld	de,splash_80c
0122: 1803    		jr	banner0
              	
              		; Print banner
0124: 116402  	banner:	ld	de,splash_40c
0127: 0E09    	banner0:ld	c,0x09
0129: CD0500  		call	bdos
              	
012C: C9      		ret
              		
              	; Actually does the configuration
012D: CD4102  	docfg:	call	setdma
0130: 0E14    		ld	c,0x14
0132: 115C00  		ld	de,fcb
0135: CD0500  		call	bdos		; Read file
              		
0138: CD0002  		call	setcol		; Set color
013B: CD0C02  		call	setf18
013E: C9      		ret
              			
              		; Do user configuration
              		; Attempt to load INIT.INI
013F: CD3702  	config:	call	openini
0142: CA6D01  		jp	z,cretini	; Can't open, create it!
              		
0145: CD2D01  		call	docfg
              		
0148: 0E09    	prompt:	ld	c,0x09
014A: 111104  		ld	de,cfgmsg
014D: CD0500  		call	bdos
              		
              		; Get user option
0150: 0E0A    		ld	c,0x0A
0152: 11F405  		ld	de,inpbuf
0155: CD0500  		call	bdos
0158: 3AF605  		ld	a,(inpbuf+2)
              		
              		; Do commands?
015B: FE31    		cp	'1'
015D: CA9801  		jp	z,cfgcol
0160: FE32    		cp	'2'
0162: CAE901  		jp	z,cfgf18
              		
              		; Look for exit condition
0165: FE39    		cp	'9'
0167: CA8201  		jp	z,save
              		
016A: 18DC    		jr	prompt
016C: C9      		ret
              		
              		; Create the ini file
016D: CD2502  	cretini:call	setf
0170: 0E16    		ld	c,0x16
0172: CD0500  		call	bdos
              		
              		; Default values
0175: 3EE1    		ld	a,0xE1		; Default color
0177: 32F805  		ld	(tsmcol),a
017A: 3E00    		ld	a,0x00		; 80-col disabled
017C: 32F905  		ld	(f18a80),a
              		
017F: C34801  		jp	prompt
              		
              		; Save the file and exit
0182: CD3702  	save:	call	openini
0185: CD4102  		call	setdma
0188: 0E15    		ld	c,0x15
018A: 115C00  		ld	de,fcb
018D: CD0500  		call	bdos
              		
              		; Close and exit
0190: 0E10    		ld	c,0x10
0192: 115C00  		ld	de,fcb
0195: C30500  		jp	bdos
              		
              		; Configure colors
0198: 0E09    	cfgcol:	ld	c,0x09
019A: 118B04  		ld	de,colmsg
019D: CD0500  		call	bdos
              		
              		; Do foreground color
01A0: 0E09    	fgcol:	ld	c,0x09
01A2: 11CA05  		ld	de,formsg
01A5: CD0500  		call	bdos
              		
              		; Get user option
01A8: 0E0A    		ld	c,0x0A
01AA: 11F405  		ld	de,inpbuf
01AD: CD0500  		call	bdos
01B0: 3AF605  		ld	a,(inpbuf+2)
01B3: CD4902  		call	ltou
01B6: D641    		sub	'A'
01B8: FE10    		cp	16
01BA: 30E4    		jr	nc,fgcol
01BC: 07      		rlca
01BD: 07      		rlca
01BE: 07      		rlca
01BF: 07      		rlca
01C0: 47      		ld	b,a
01C1: C5      		push	bc
              		
              		; Do background color
01C2: 0E09    	bgcol:	ld	c,0x09
01C4: 11DF05  		ld	de,bacmsg
01C7: CD0500  		call	bdos
              		
              		; Get user option
01CA: 0E0A    		ld	c,0x0A
01CC: 11F405  		ld	de,inpbuf
01CF: CD0500  		call	bdos
01D2: 3AF605  		ld	a,(inpbuf+2)
01D5: CD4902  		call	ltou
01D8: D641    		sub	'A'
01DA: FE10    		cp	16
01DC: 30E4    		jr	nc,bgcol
01DE: C1      		pop	bc
01DF: B0      		or	b
              		
01E0: 32F805  		ld	(tsmcol),a
01E3: CD0002  		call	setcol
01E6: C34801  		jp	prompt
              		
              		; Configure F18A
01E9: 3AF905  	cfgf18:	ld	a,(f18a80)
01EC: B7      		or	a
01ED: 2806    		jr	z,cfgf180
              		
              		; Disable F18A mode
01EF: AF      		xor	a
01F0: 32F905  		ld	(f18a80),a
01F3: 1805    		jr	cfgf181
              		
              		; Enable F18A mode
01F5: 3E01    	cfgf180:ld	a,1
01F7: 32F905  		ld	(f18a80),a
              		
              		; Update settings
01FA: CD0C02  	cfgf181:call	setf18
01FD: C34801  		jp	prompt
              		
              	; Sets the TMS9918 color 
0200: DBA1    	setcol:	in	a,(tm_latc)
0202: 3AF805  		ld	a,(tsmcol)
0205: D3A1    		out	(tm_latc),a
0207: 3E87    		ld	a,0x87
0209: D3A1    		out	(tm_latc),a
020B: C9      		ret
              		
              	; Sets the F18A mode
020C: 3AF905  	setf18:	ld	a,(f18a80)
020F: B7      		or	a
0210: 3EFF    		ld	a,255
0212: 2802    		jr	z,setf180
0214: 3EFE    		ld	a,254
0216: 5F      	setf180:ld	e,a
0217: D5      		push	de
0218: 0E02    		ld	c,2
021A: 1E1B    		ld	e,0x1B
021C: CD0500  		call	bdos
021F: 0E02    		ld	c,2
0221: D1      		pop	de
0222: C30500  		jp	bdos
              		
              	; Sets the FCB for a file open or creation
              	;
              	; Returns FCB in DE
              	; uses: af, bc, de, hl 
0225: 215402  	setf:	ld	hl,inifile
0228: 115C00  		ld	de,fcb
022B: D5      		push	de
022C: 011000  		ld	bc,16
022F: EDB0    		ldir
0231: AF      		xor	a
0232: 327C00  		ld	(fcb+0x20),a
0235: D1      		pop	de
0236: C9      		ret
              		
              	; Attempt to open the ini file
              	;
              	; Returns z if failed
              	; uses: all
0237: CD2502  	openini:call	setf
023A: 0E0F    		ld	c,0x0F
023C: CD0500  		call	bdos
023F: 3C      		inc	a
0240: C9      		ret
              		
              	; Set DMA to top of memory
0241: 11F805  	setdma:	ld	de,top
0244: 0E1A    		ld	c,0x1A
0246: C30500  		jp	bdos
              		
              	; Converts lowercase to uppercase
              	; a = Character to convert
              	;
              	; Returns uppercase in A
              	; uses: af
0249: E67F    	ltou:	and	0x7F
024B: FE61    		cp	0x61		; 'a'
024D: D8      		ret	c
024E: FE7B    		cp	0x7B		; '{'
0250: D0      		ret	nc
0251: D620    		sub	0x20
0253: C9      		ret
              		
              	; Strings
              	
              	; File prototype
              	; Length: 16 bytes
0254:         	inifile:
0254: 00494E49		defb	0,'INIT    INI',0,0,0,0
0258: 54202020	
025C: 20494E49	
0260: 00000000	
              		
0264:         	splash_40c:
0264: 80808020		defb	0x80,0x80,0x80,0x20,0x80,0x80,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x80,0x80,' CP/M Version 2.2',0x0A,0x0D
0268: 80808020	
026C: 80208020	
0270: 80208020	
0274: 80208020	
0278: 80808020	
027C: 43502F4D	
0280: 20566572	
0284: 73696F6E	
0288: 20322E32	
028C: 0A0D    	
028E: 20802020	    	defb	0x20,0x80,0x20,0x20,0x80,0x20,0x20,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x0A,0x0D  
0292: 80202020	
0296: 80208020	
029A: 80208020	
029E: 80208020	
02A2: 8020800A	
02A6: 0D      	
02A7: 20802020		defb	0x20,0x80,0x20,0x20,0x80,0x80,0x80,0x20,0x80,0x80,0x80,0x20,0x80,0x80,0x20,0x20,0x80,0x20,0x80,0x20,0x80,0x80,0x20,' Revision BETA',0x0A,0x0D	
02AB: 80808020	
02AF: 80808020	
02B3: 80802020	
02B7: 80208020	
02BB: 80802020	
02BF: 52657669	
02C3: 73696F6E	
02C7: 20424554	
02CB: 410A0D  	
02CE: 20802020		defb	0x20,0x80,0x20,0x20,0x20,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x0A,0x0D
02D2: 20208020	
02D6: 80208020	
02DA: 80208020	
02DE: 80208020	
02E2: 8020800A	
02E6: 0D      	
02E7: 80808020		defb	0x80,0x80,0x80,0x20,0x80,0x80,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x20,0x80,0x80,0x80,0x20,0x80,0x20,0x80,0x0A,0x0D
02EB: 80808020	
02EF: 80208020	
02F3: 80208020	
02F7: 80808020	
02FB: 8020800A	
02FF: 0D      	
0300: 24      		defb	'$'
              	
0301:         	splash_80c:
              	;	defb	' _____  _____ _    _ _  ___    _ _____   ',0x0A,0x0D
              	;	defb	'|_   _|/ ____| |  | | |/ / |  | |  __ \  ',' CP/M Version 2.2',0x0A,0x0D
              	;	defb	'  | | | (___ | |__| | | /| |  | | |__) | ',0x0A,0x0D
              	;	defb	'  | |  \___ \|  __  |  < | |  | |  _  /  ',' Revision BETA',0x0A,0x0D
              	;	defb	' _| |_ ____) | |  | | . \| |__| | | \ \  ',0x0A,0x0D
              	;	defb	'|_____|_____/|_|  |_|_|\_\\____/|_|  \_\ ',0x0A,0x0D
              	;	defb	'$'
0301: 80808080		defb	0x80,0x80, 0x80,0x80, 0x80,0x80, 0x20,0x20, 0x20,0x80, 0x80,0x80, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x80,0x80, 0x80,0x20, ' CP/M Version 2.2',0x0A,0x0D
0305: 80802020	
0309: 20808080	
030D: 80802020	
0311: 80802020	
0315: 80802020	
0319: 80802020	
031D: 80802020	
0321: 80802020	
0325: 80802020	
0329: 80808080	
032D: 80202043	
0331: 502F4D20	
0335: 56657273	
0339: 696F6E20	
033D: 322E320A	
0341: 0D      	
0342: 20208080	    	defb	0x20,0x20, 0x80,0x80, 0x20,0x20, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x20,0x20, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x0A,0x0D  
0346: 20202020	
034A: 80802020	
034E: 20202020	
0352: 80802020	
0356: 80802020	
035A: 80802020	
035E: 80802020	
0362: 80802020	
0366: 80802020	
036A: 80802020	
036E: 80800A0D	
0372: 20208080		defb	0x20,0x20, 0x80,0x80, 0x20,0x20, 0x20,0x20, 0x80,0x80, 0x80,0x80, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x80,0x80, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x80,0x80, 0x20,0x20, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x80,0x80, 0x20,0x20, ' Revision BETA',0x0A,0x0D	
0376: 20202020	
037A: 80808080	
037E: 80802020	
0382: 80808080	
0386: 80802020	
038A: 80808080	
038E: 20202020	
0392: 80802020	
0396: 80802020	
039A: 80808080	
039E: 20202052	
03A2: 65766973	
03A6: 696F6E20	
03AA: 42455441	
03AE: 0A0D    	
03B0: 20208080		defb	0x20,0x20, 0x80,0x80, 0x20,0x20, 0x20,0x20, 0x20,0x20, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x0A,0x0D
03B4: 20202020	
03B8: 20202020	
03BC: 80802020	
03C0: 80802020	
03C4: 80802020	
03C8: 80802020	
03CC: 80802020	
03D0: 80802020	
03D4: 80802020	
03D8: 80802020	
03DC: 80800A0D	
03E0: 80808080		defb	0x80,0x80, 0x80,0x80, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x80,0x80, 0x80,0x20, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x20,0x80, 0x80,0x80, 0x80,0x20, 0x20,0x20, 0x80,0x80, 0x20,0x20, 0x80,0x80, 0x0A,0x0D
03E4: 80802020	
03E8: 80808080	
03EC: 80202020	
03F0: 80802020	
03F4: 80802020	
03F8: 80802020	
03FC: 80802020	
0400: 20808080	
0404: 80202020	
0408: 80802020	
040C: 80800A0D	
0410: 24      		defb	'$'
              	
0411:         	cfgmsg:
0411: 0A0D4953		defb	0x0A,0x0D,'ISHKUR CP/M Configuration',0x0A,0x0A,0x0D
0415: 484B5552	
0419: 2043502F	
041D: 4D20436F	
0421: 6E666967	
0425: 75726174	
0429: 696F6E0A	
042D: 0A0D    	
              		
042F: 20202020		defb	'    1: Change TMS9918 Text Color',0x0A,0x0D
0433: 313A2043	
0437: 68616E67	
043B: 6520544D	
043F: 53393931	
0443: 38205465	
0447: 78742043	
044B: 6F6C6F72	
044F: 0A0D    	
0451: 20202020		defb	'    2: Toggle F18A 80 Column Mode',0x0A,0x0D
0455: 323A2054	
0459: 6F67676C	
045D: 65204631	
0461: 38412038	
0465: 3020436F	
0469: 6C756D6E	
046D: 204D6F64	
0471: 650A0D  	
0474: 20202020		defb	'    9: Exit',0x0A,0x0A,0x0D
0478: 393A2045	
047C: 7869740A	
0480: 0A0D    	
0482: 4F707469		defb	'Option: $'
0486: 6F6E3A20	
048A: 24      	
              		
048B:         	colmsg:
048B: 0A0D544D		defb	0x0A,0x0D,'TMS9918 Text Color Configuration',0x0A,0x0D
048F: 53393931	
0493: 38205465	
0497: 78742043	
049B: 6F6C6F72	
049F: 20436F6E	
04A3: 66696775	
04A7: 72617469	
04AB: 6F6E0A0D	
04AF: 20202020		defb	'    A: Transparent',0x0A,0x0D
04B3: 413A2054	
04B7: 72616E73	
04BB: 70617265	
04BF: 6E740A0D	
04C3: 20202020		defb	'    B: Black',0x0A,0x0D
04C7: 423A2042	
04CB: 6C61636B	
04CF: 0A0D    	
04D1: 20202020		defb	'    C: Medium Green',0x0A,0x0D
04D5: 433A204D	
04D9: 65646975	
04DD: 6D204772	
04E1: 65656E0A	
04E5: 0D      	
04E6: 20202020		defb	'    D: Light Green',0x0A,0x0D
04EA: 443A204C	
04EE: 69676874	
04F2: 20477265	
04F6: 656E0A0D	
04FA: 20202020		defb	'    E: Dark Blue',0x0A,0x0D
04FE: 453A2044	
0502: 61726B20	
0506: 426C7565	
050A: 0A0D    	
050C: 20202020		defb	'    F: Light Blue',0x0A,0x0D
0510: 463A204C	
0514: 69676874	
0518: 20426C75	
051C: 650A0D  	
051F: 20202020		defb	'    G: Dark Red',0x0A,0x0D
0523: 473A2044	
0527: 61726B20	
052B: 5265640A	
052F: 0D      	
0530: 20202020		defb	'    H: Cyan',0x0A,0x0D
0534: 483A2043	
0538: 79616E0A	
053C: 0D      	
053D: 20202020		defb	'    I: Medium Red',0x0A,0x0D
0541: 493A204D	
0545: 65646975	
0549: 6D205265	
054D: 640A0D  	
0550: 20202020		defb	'    J: Light Red',0x0A,0x0D
0554: 4A3A204C	
0558: 69676874	
055C: 20526564	
0560: 0A0D    	
0562: 20202020		defb	'    K: Dark Yellow',0x0A,0x0D
0566: 4B3A2044	
056A: 61726B20	
056E: 59656C6C	
0572: 6F770A0D	
0576: 20202020		defb	'    L: Light Yellow',0x0A,0x0D
057A: 4C3A204C	
057E: 69676874	
0582: 2059656C	
0586: 6C6F770A	
058A: 0D      	
058B: 20202020		defb	'    M: Dark Green',0x0A,0x0D
058F: 4D3A2044	
0593: 61726B20	
0597: 47726565	
059B: 6E0A0D  	
059E: 20202020		defb	'    N: Magenta',0x0A,0x0D
05A2: 4E3A204D	
05A6: 6167656E	
05AA: 74610A0D	
05AE: 20202020		defb	'    O: Grey',0x0A,0x0D
05B2: 4F3A2047	
05B6: 7265790A	
05BA: 0D      	
05BB: 20202020		defb	'    P: White',0x0A,0x0D,'$'
05BF: 503A2057	
05C3: 68697465	
05C7: 0A0D24  	
              		
05CA:         	formsg:	
05CA: 0A0D466F		defb	0x0A,0x0D,'Foreground Color: $'
05CE: 72656772	
05D2: 6F756E64	
05D6: 20436F6C	
05DA: 6F723A20	
05DE: 24      	
05DF:         	bacmsg:	
05DF: 0A0D4261		defb	0x0A,0x0D,'Background Color: $'
05E3: 636B6772	
05E7: 6F756E64	
05EB: 20436F6C	
05EF: 6F723A20	
05F3: 24      	
              		
              		
              	; Input buffer
05F4: 02000000	inpbuf:	defb	0x02, 0x00, 0x00, 0x00
              		
              	; Top of program, use it to store stuff
05F8:         	top:
05F8:         	tsmcol	equ	top	; TMS9918 Color (1 byte)
05F9:         	f18a80	equ	top+1	; F18A 80 Column (1 byte)


; +++ segments +++

#CODE          = $0100 =   256,  size = $04F8 =  1272

; +++ global symbols +++

_end       = $05F8 =  1528          init.asm:30 (unused)
_size      = $04F8 =  1272          init.asm:30 (unused)
bacmsg     = $05DF =  1503          init.asm:314
banner     = $0124 =   292          init.asm:54
banner0    = $0127 =   295          init.asm:55
bdos       = $0005 =     5          init.asm:20
bgcol      = $01C2 =   450          init.asm:152
cfgcol     = $0198 =   408          init.asm:126
cfgf18     = $01E9 =   489          init.asm:173
cfgf180    = $01F5 =   501          init.asm:183
cfgf181    = $01FA =   506          init.asm:187
cfgmsg     = $0411 =  1041          init.asm:285
cmdarg     = $0081 =   129          init.asm:23
cmdlen     = $0080 =   128          init.asm:22
colmsg     = $048B =  1163          init.asm:293
config     = $013F =   319          init.asm:72
cretini    = $016D =   365          init.asm:101
docfg      = $012D =   301          init.asm:61
f18a80     = $05F9 =  1529          init.asm:324
fcb        = $005C =    92          init.asm:21
fgcol      = $01A0 =   416          init.asm:131
formsg     = $05CA =  1482          init.asm:312
inifile    = $0254 =   596          init.asm:259
inpbuf     = $05F4 =  1524          init.asm:319
ltou       = $0249 =   585          init.asm:247
openini    = $0237 =   567          init.asm:231
prompt     = $0148 =   328          init.asm:77
save       = $0182 =   386          init.asm:114
setcol     = $0200 =   512          init.asm:191
setdma     = $0241 =   577          init.asm:238
setf       = $0225 =   549          init.asm:217
setf18     = $020C =   524          init.asm:199
setf180    = $0216 =   534          init.asm:204
splash_40c = $0264 =   612          init.asm:262
splash_80c = $0301 =   769          init.asm:270
tm_data    = $00A0 =   160          init.asm:25 (unused)
tm_latc    = $00A1 =   161          init.asm:26
top        = $05F8 =  1528          init.asm:322
tsmcol     = $05F8 =  1528          init.asm:323


total time: 0.0030 sec.
no errors
