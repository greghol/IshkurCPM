              	; --------------------------------------
              	; zasm: assemble "boot\boot_net_ide.asm"
              	; date: 2023-07-09 14:06:13
              	; --------------------------------------


              	;
              	;**************************************************************
              	;*
              	;*        I S H K U R   N E T B O O T   I D E
              	;*
              	;*    Reads the first 512 bytes of an IDE device 
              	;*    and jumps to it. Useful for testing an IDE
              	;*    device without a modified bootrom.
              	;*
              	;**************************************************************
              	;
              	
0006:         	nsec	equ	6		; # of BDOS+BIOS sectors 
              					; (1024 bytes each)
0037:         	mem	equ	55		; CP/M image starts at mem*1024
              					; Should be same as cpm22.asm
              					
0040:         	aydata	equ	0x40		; AY-3-8910 data port
0041:         	aylatc	equ	0x41		; AY-3-8910 latch port
              	
00C0:         	id_base	equ	0xC0		; IDE Base address
              	
              	
3000:         	scratch	equ	0x3000
              	; NABU bootstrap loads in at 0xB000
B000:         	entry	equ	0xB000 ; Bootloader entry address
              	
              	
              	
B000:         		org	entry
              	
B000: 00      		nop
B001: 00      		nop
B002: 00      		nop
B003:         	start:
B003: 310330  		ld sp, scratch + 3             ; Set stack pointer
B006: 3EC9    		ld a, $C9                      ; A = $C9 (return opcode)
B008: 320030  		ld (scratch), a                ; Place return statement at address 3000
B00B: CD0030  		call scratch                   ; Call address 3000 (and return)
B00E: 2A0130  		ld hl, (scratch + 1)           ; Load return address from stack, this will be the address immediately following the call 3000 statement
B011: 111300  		ld de, code_start-$ + 3        ; DE = address of bootloader relative to the call 0 return address
B014: 19      		add hl, de                     ; HL = absolute address where bootloader is currently residing
B015: 1100B0  		ld de, entry                   ; DE = address to copy bootloader to.
B018: 016A00  		ld bc, code_length             ; BC = length of bootloader
B01B: EDB0    		ldir                           ; Relocate ourselves to known address
B01D: 2100B0  		ld hl, entry                   ; HL = entry point of bootloader
B020: E9      		jp (hl)                        ; Jump to bootloader
              	
              	.PHASE entry
B021:         	code_start:  equ $$
              	
              	; Boot start same as NABU bootstrap
B000:         	base:
B021: F3      		di
B022: 00      		nop
B023: 3100B0  		ld	sp,base
              	
              		; Select master
B026: 3EE0    		ld	a,0xE0
B028: D3CC    		out	(id_base+0xC),a
B02A: 060A    		ld	b,10
B02C: CD65B0  		call	id_stal
              	
              		; Set up registers
B02F: AF      		xor	a
B030: D3C6    		out	(id_base+0x6),a
B032: D3C8    		out	(id_base+0x8),a
B034: D3CA    		out	(id_base+0xA),a
B036: 3C      		inc	a
B037: D3C4    		out	(id_base+0x4),a
B039: 2100C0  		ld	hl,0xC000
              	
              		; Read physical
B03C: CD2DB0  		call	id_rphy
              	
              		; Check magic
B03F: 2A00C0  		ld	hl,(0xC000)
B042: 111806  		ld	de,0x0618
B045: B7      		or	a
B046: ED52    		sbc	hl,de
B048: C20000  		jp	nz,0
              	
B04B: C300C0  		jp	0xC000
              		
              	; Executes a read command
              	; hl = Destination of data
              	;
              	; Returns hl += 512
              	; uses: af, bc, d, hl
B04E: CD58B0  	id_rphy:call	id_busy
B051: 3E20    		ld	a,0x20
B053: CD50B0  		call	id_comm
B056: CD49B0  		call	id_wdrq
B059: 1600    		ld	d,0
B05B: 0EC0    		ld	c,id_base
B05D: EDA2    	id_rph0:ini
B05F: 0C      		inc	c
B060: EDA2    		ini
B062: 0D      		dec	c
B063: 15      		dec	d
B064: 20F7    		jr	nz,id_rph0
B066: CD58B0  		call	id_busy
B069: C9      		ret
              	
              	; Waits for a DRQ (Data Request)
              	;
              	; uses: af
B06A: DBCE    	id_wdrq:in	a,(id_base+0xE)
B06C: CB5F    		bit	3,a
B06E: 28FA    		jr	z,id_wdrq
B070: C9      		ret
              		
              	; Issues an IDE command
              	; a = Command to issue
              	;
              	; uses: af
B071: F5      	id_comm:push	af
B072: CD58B0  		call	id_busy
B075: F1      		pop	af
B076: D3CE    		out	(id_base+0xE),a
B078: C9      		ret
              		
              		
              	; Waits for the IDE drive to no longer be busy
              	;
              	; Resets flag z on error
B079: DBCE    	id_busy:in	a,(id_base+0xE)
B07B: CB77    		bit	6,a
B07D: 28FA    		jr	z,id_busy
B07F: CB7F    		bit	7,a
B081: 20F6    		jr	nz,id_busy
B083: CB47    		bit	0,a
B085: C9      		ret
              	
              	
              	; Waits a little bit
              	;
              	; uses: b
B086: C5      	id_stal:push	bc
B087: C1      		pop	bc
B088: 10FC    		djnz	id_stal
B08A: C9      		ret
              		
              	
006A:         	code_length: equ $$-code_start
              	.DEPHASE


; +++ segments +++

#CODE          = $B000 = 45056,  size = $008B =   139

; +++ global symbols +++

_end        = $B08B = 45195          boot\boot_net_ide.asm:30 (unused)
_size       = $008B =   139          boot\boot_net_ide.asm:30 (unused)
aydata      = $0040 =    64          boot\boot_net_ide.asm:18 (unused)
aylatc      = $0041 =    65          boot\boot_net_ide.asm:19 (unused)
base        = $B000 = 45056          boot\boot_net_ide.asm:53
code_length = $006A =   106          boot\boot_net_ide.asm:145
code_start  = $B021 = 45089          boot\boot_net_ide.asm:50
entry       = $B000 = 45056          boot\boot_net_ide.asm:26
id_base     = $00C0 =   192          boot\boot_net_ide.asm:21
id_busy     = $B058 = 45144          boot\boot_net_ide.asm:127
id_comm     = $B050 = 45136          boot\boot_net_ide.asm:117
id_rph0     = $B03C = 45116          boot\boot_net_ide.asm:96
id_rphy     = $B02D = 45101          boot\boot_net_ide.asm:90
id_stal     = $B065 = 45157          boot\boot_net_ide.asm:139
id_wdrq     = $B049 = 45129          boot\boot_net_ide.asm:108
mem         = $0037 =    55          boot\boot_net_ide.asm:15 (unused)
nsec        = $0006 =     6          boot\boot_net_ide.asm:13 (unused)
scratch     = $3000 = 12288          boot\boot_net_ide.asm:24
start       = $B003 = 45059          boot\boot_net_ide.asm:35 (unused)


total time: 0.0018 sec.
no errors
